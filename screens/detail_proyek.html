<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Proyek - CV. LINGGA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            background: #f5f5f5;
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .logo {
            padding: 24px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: #4361ee;
            letter-spacing: 1px;
        }

        .menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #f8f9fa;
            border-left-color: #4361ee;
            color: #4361ee;
        }

        .menu-item.active {
            background: #f0f4ff;
            border-left-color: #4361ee;
            color: #4361ee;
            font-weight: 600;
        }

        .menu-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        .user-profile {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #c3c3c3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .user-email {
            font-size: 12px;
            color: #666;
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .btn-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            color: #666;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: #f8f9fa;
        }

        .btn-rekap {
            background: #8b5cf6;
            /* ungu */
            color: white;
        }

        .btn-rekap:hover {
            background: #7c3aed;
        }

        .header-title h2 {
            font-size: 32px;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.proses {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.selesai {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.telat {
            background: #fee2e2;
            color: #b91c1c;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #4361ee;
            color: white;
        }

        .btn-selesai {
            background: #10b981;
            color: white;
        }

        .btn-hapus {
            background: #ef4444;
            color: white;
        }

        .project-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .info-value {
            font-size: 16px;
            color: #1a1a1a;
            font-weight: 500;
        }

        .map-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .pekerja-list {
            max-height: 420px;
            /* tinggi tetap */
            overflow-y: auto;
            /* scroll di sini */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pekerja-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pekerja-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4361ee;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .pekerja-info {
            flex: 1;
        }

        .pekerja-name {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .pekerja-frame {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            background: #fff;
        }

        .pekerja-position {
            font-size: 13px;
            color: #6b7280;
            /* abu-abu soft */
            margin-top: 2px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #1a1a1a;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            border: none;
            background: transparent;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #4361ee;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .worker-selection {
            max-height: 267px;
            /* tinggi tetap */
            overflow-y: auto;
            /* scroll jika melebihi tinggi */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }

        .worker-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .worker-checkbox:hover {
            background: #f8f9fa;
        }

        .worker-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .worker-checkbox label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-weight: 400;
        }

        .worker-top-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .worker-top-bar input {
            flex: 2;
        }

        .worker-top-bar select {
            flex: 1;
        }

        .btn-tim {
            white-space: nowrap;
            padding: 10px 16px;
        }

        .team-selection {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-cancel {
            flex: 1;
            padding: 12px;
            background: white;
            color: #666;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-submit {
            flex: 2;
            padding: 12px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        @media (max-width: 1024px) {
            .project-content {
                grid-template-columns: 1fr;
            }
        }

        #projectDescription {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            display: block;
            /* pastikan block */
            width: 100%;
            /* ambil full lebar container */
            max-width: 100%;
            /* jangan melebar melebihi container */
            overflow-wrap: anywhere;
            /* memaksa kata panjang untuk wrap */
            text-align: justify;
        }

        .info-value {
            word-break: break-word;
            overflow-wrap: anywhere;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo">
            <h1>CV. LINGGA</h1>
        </div>

        <div class="menu">
            <a class="menu-item" href="proyek_aktif.html">
                <i data-feather="briefcase" class="menu-item-icon"></i>
                <span>Proyek Aktif</span>
            </a>

            <a class="menu-item" href="proyek_selesai.html">
                <i data-feather="check-square" class="menu-item-icon"></i>
                <span>Proyek Selesai</span>
            </a>

            <a class="menu-item" href="supervisor_lapangan.html">
                <i data-feather="users" class="menu-item-icon"></i>
                <span>Supervisor</span>
            </a>

            <a class="menu-item" href="pekerja.html">
                <i data-feather="tool" class="menu-item-icon"></i>
                <span>Pekerja</span>
            </a>
        </div>

        <div class="user-profile" onclick="window.location.href='profil.html'">
            <div class="user-avatar"></div>
            <div class="user-info">
                <div class="user-name">Loading...</div>
                <div class="user-email">Loading...</div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="content-header">
            <div class="header-left">
                <button class="btn-back" onclick="window.location.href='proyek_aktif.html'">
                    <i data-feather="arrow-left"></i>
                    Kembali
                </button>
                <div class="header-title">
                    <h2 id="projectTitle">Loading...</h2>
                    <span class="badge proses" id="projectStatus">Loading...</span>
                </div>
            </div>
            <div class="action-buttons" id="actionButtons">
                <!-- Buttons will be added dynamically -->
            </div>
        </div>

        <div class="project-content">
            <div>
                <div class="project-card">
                    <h3 class="card-title">Informasi Proyek</h3>
                    <div class="info-grid" id="projectInfo">
                        <!-- Info will be loaded dynamically -->
                    </div>

                    <div class="info-item">
                        <div class="info-label">Deskripsi</div>
                        <div class="info-value" id="projectDescription">-</div>
                    </div>
                </div>
            </div>

            <div>
                <div class="project-card">
                    <h3 class="card-title">
                        Daftar Pekerja (<span id="workerCount">0</span>)
                    </h3>

                    <!-- ðŸ” SEARCH BAR (STATIS) -->
                    <input type="text" id="pekerjaSearch" placeholder="Cari nama pekerja..."
                        oninput="filterPekerjaDetail()" style="margin-bottom: 12px;">

                    <!-- ðŸ§± FRAME STATIS -->
                    <div class="pekerja-frame">
                        <!-- ðŸ”½ ISI SCROLL -->
                        <div class="pekerja-list" id="pekerjaList">
                            <!-- Workers -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            <div class="modal-header">
                <h3>Edit Proyek</h3>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label>Nama Proyek</label>
                    <input type="text" id="editNamaProyek" required>
                </div>

                <div class="form-group">
                    <label>Nama Client</label>
                    <input type="text" id="editNamaClient" required>
                </div>

                <div class="form-group">
                    <label>Tanggal Mulai</label>
                    <input type="date" id="editTanggalMulai" required>
                </div>

                <div class="form-group">
                    <label>Tenggat Proyek</label>
                    <input type="date" id="editTenggat" required>
                </div>

                <div class="form-group">
                    <label>Supervisor</label>
                    <select id="editSupervisor" required>
                        <option value="">Pilih Supervisor</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Pilih Pekerja</label>

                    <!-- ðŸ” BARIS ATAS: search + tim + tambah -->
                    <div class="worker-top-bar">
                        <input type="text" id="workerSearch" placeholder="Cari pekerja..."
                            oninput="filterWorkers()">

                        <select id="editTeamSelect">
                            <option value="">Pilih Tim</option>
                        </select>

                        <button type="button" class="btn-action btn-edit btn-tim"
                            onclick="addTeamToEdit()">
                            Tambah Tim
                        </button>
                    </div>

                    <!-- ðŸ”½ LIST PEKERJA -->
                    <div class="worker-selection" id="editWorkerSelection"></div>

                    <div id="workerCountText" style="margin-top:8px;font-size:13px;color:#666;">
                        0 pekerja dipilih
                    </div>
                </div>

                <div class="form-group">
                    <label>Lokasi Proyek</label>
                    <input type="text" id="editLokasi" placeholder="Masukkan alamat atau lokasi proyek" required>
                </div>

                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="editDeskripsi"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Batal</button>
                    <button type="submit" class="btn-submit">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h3 id="confirmTitle">Konfirmasi</h3>
            </div>

            <p id="confirmMessage" style="margin-bottom: 24px; color:#444; line-height:1.6;">
                Apakah Anda yakin?
            </p>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeConfirmModal()">Batal</button>
                <button class="btn-submit" id="confirmActionBtn">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZWXurY0DGfIWxeKTRvWv6aPohsGIG9OE",
            authDomain: "project-kp-fd649.firebaseapp.com",
            projectId: "project-kp-fd649"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        feather.replace();

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        let projectData = null;
        let currentUser = null;
        let selectedWorkers = [];

        import { query, where } from
            "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Cari admin berdasarkan email login
                const q = query(
                    collection(db, "admin"),
                    where("email", "==", user.email)
                );

                const snap = await getDocs(q);

                // Ambil 1 data admin (harusnya cuma 1)
                const adminDoc = snap.docs[0];
                const adminData = adminDoc.data();

                // ðŸ”¥ Update profil kiri bawah
                document.querySelector('.user-name').textContent = adminData.nama;
                document.querySelector('.user-email').textContent = adminData.email;

                // Avatar: gambar base64 ATAU inisial
                const avatarEl = document.querySelector('.user-avatar');

                if (adminData.avatar && adminData.avatar.startsWith("data:image")) {
                    avatarEl.innerHTML = `<img src="${adminData.avatar}">`;
                } else {
                    avatarEl.textContent = adminData.nama
                        .split(' ')
                        .map(n => n[0])
                        .join('')
                        .substring(0, 2)
                        .toUpperCase();
                }

                loadProject();

            } catch (err) {
                console.error(err);
                alert("Gagal memuat data admin");
            }
        });
        async function loadProject() {
            const docSnap = await getDoc(doc(db, "projects", projectId));
            if (!docSnap.exists()) {
                alert('Proyek tidak ditemukan');
                window.history.back();
                return;
            }

            projectData = docSnap.data();

            document.getElementById('projectTitle').textContent = projectData.namaProyek;

            const statusBadge = document.getElementById('projectStatus');
            const rawStatus = projectData.status || '';
            const displayStatus = rawStatus
                ? rawStatus.charAt(0).toUpperCase() + rawStatus.slice(1)
                : '';
            statusBadge.textContent = displayStatus;
            statusBadge.className = 'badge';

            if (projectData.status === 'selesai') {
                statusBadge.classList.add('selesai');
            } else if (projectData.status === 'telat') {
                statusBadge.classList.add('telat');
            } else {
                statusBadge.classList.add('proses');
            }

            const actionButtons = document.getElementById('actionButtons');
            actionButtons.innerHTML = '';

            if (projectData.status !== 'selesai' && projectData.status !== 'telat') {
                actionButtons.innerHTML = `
                    <button class="btn-action btn-edit" onclick="openEditModal()">
                        <i data-feather="edit"></i>
                        Edit
                    </button>
                    <button class="btn-action btn-selesai" onclick="markAsComplete()">
                        <i data-feather="check-circle"></i>
                        Tandai Selesai
                    </button>
                    <button class="btn-action btn-rekap" onclick="goToRekap()">
                        <i data-feather="calendar"></i>
                        Rekap Mingguan
                    </button>
                `;
            }

            actionButtons.innerHTML += `
                <button class="btn-action btn-hapus" onclick="deleteProject()">
                    <i data-feather="trash-2"></i>
                    Hapus
                </button>
            `;

            const alamat = projectData.lokasi || '-';

            document.getElementById('projectInfo').innerHTML = `
                <div class="info-item">
                    <div class="info-label">Nama Client</div>
                    <div class="info-value">${projectData.namaClient}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Supervisor</div>
                    <div class="info-value">${projectData.supervisor?.nama || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Tanggal Mulai</div>
                    <div class="info-value">${projectData.tanggalMulai}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Tenggat</div>
                    <div class="info-value">${projectData.tenggat}</div>
                </div>
                <div class="info-item" style="grid-column: 1 / -1;">
                    <div class="info-label">Lokasi</div>
                    <div class="info-value">${alamat}</div>
                </div>
            `;

            document.getElementById('projectDescription').textContent = projectData.deskripsi || '-';
            document.getElementById('workerCount').textContent = projectData.jumlahPekerja || 0;

            const pekerjaList = document.getElementById('pekerjaList');

            if (projectData.pekerja && projectData.pekerja.length > 0) {
                const pekerjaRefs = projectData.pekerja;

                /* ðŸ”¥ ambil data lengkap pekerja */
                const pekerjaLengkap = [];

                for (const p of pekerjaRefs) {
                    if (!p.id) continue;

                    const pekerjaSnap = await getDoc(doc(db, "pekerja", p.id));
                    if (pekerjaSnap.exists()) {
                        pekerjaLengkap.push({
                            id: p.id,
                            ...pekerjaSnap.data()
                        });
                    }
                }

                /* ðŸ”¥ SORT Aâ€“Z */
                pekerjaLengkap.sort((a, b) =>
                    a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' })
                );

                /* ðŸ”¥ BUILD HTML */
                let pekerjaHTML = '';
                pekerjaLengkap.forEach(pekerja => {
                    const initials = pekerja.nama
                        .split(' ')
                        .map(n => n[0])
                        .join('')
                        .substring(0, 2)
                        .toUpperCase();

                    pekerjaHTML += `
        <div class="pekerja-item" data-nama="${pekerja.nama.toLowerCase()}">
            <div class="pekerja-avatar">${initials}</div>
            <div class="pekerja-info">
                <div class="pekerja-name">${pekerja.nama}</div>
                <div class="pekerja-position">
                    ${pekerja.keterangan || 'Pekerja'}
                </div>
            </div>
        </div>
    `;
                });
                pekerjaList.innerHTML = pekerjaHTML;
            } else {
                pekerjaList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Belum ada pekerja</p>';
            }

            feather.replace();
        }

        function filterPekerjaDetail() {
            const keyword = document.getElementById('pekerjaSearch').value.toLowerCase();
            const items = document.querySelectorAll('#pekerjaList .pekerja-item');

            items.forEach(item => {
                const nama = item.getAttribute('data-nama');

                if (!keyword || nama.includes(keyword)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        window.filterPekerjaDetail = filterPekerjaDetail;
        let confirmCallback = null;

        function openConfirmModal(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;

            confirmCallback = callback;

            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
            confirmCallback = null;
        }

        document.getElementById('confirmActionBtn').addEventListener('click', async () => {
            if (confirmCallback) {
                await confirmCallback();
            }
            closeConfirmModal();
        });

        // expose ke global
        window.openConfirmModal = openConfirmModal;
        window.closeConfirmModal = closeConfirmModal;

        function markAsComplete() {
            openConfirmModal(
                "Tandai Proyek Selesai",
                "Apakah Anda yakin ingin menandai proyek ini sebagai selesai? Status tidak dapat dikembalikan.",
                async () => {
                    let statusBaru = "selesai";

                    if (projectData.tenggat) {
                        const today = new Date();
                        const tenggat = new Date(projectData.tenggat);

                        if (!isNaN(tenggat.getTime()) && today > tenggat) {
                            statusBaru = "telat";
                        }
                    }

                    await updateDoc(doc(db, "projects", projectId), { status: statusBaru });
                    loadProject();
                }
            );
        }

        window.markAsComplete = markAsComplete;

        function deleteProject() {
            openConfirmModal(
                "Hapus Proyek",
                "Proyek ini akan dihapus permanen dan tidak dapat dikembalikan. Apakah Anda yakin?",
                async () => {
                    await deleteDoc(doc(db, "projects", projectId));
                    window.location.href = 'proyek_aktif.html';
                }
            );
        }

        window.deleteProject = deleteProject;

        function goToRekap() {
            window.location.href = `rekap_mingguan.html?projectId=${projectId}`;
        }
        window.goToRekap = goToRekap;

        async function openEditModal() {
            document.getElementById('editNamaProyek').value = projectData.namaProyek;
            document.getElementById('editNamaClient').value = projectData.namaClient;
            document.getElementById('editTanggalMulai').value = projectData.tanggalMulai;
            document.getElementById('editTenggat').value = projectData.tenggat;
            document.getElementById('editDeskripsi').value = projectData.deskripsi || '';
            document.getElementById('editLokasi').value = projectData.lokasi || '';

            selectedWorkers = projectData.pekerja
                ? projectData.pekerja.map(p => p.id)
                : [];

            const supervisorSelect = document.getElementById('editSupervisor');
            supervisorSelect.innerHTML = '<option value="">Pilih Supervisor</option>';

            const supervisorsSnap = await getDocs(collection(db, "supervisors"));
            let supervisorDocIdToSet = null;

            // LOAD SEMUA SUPERVISOR KE DROPDOWN & CARI MATCH BERDASARKAN UID
            supervisorsSnap.forEach((s) => {
                const option = document.createElement("option");
                option.value = s.id; // value pakai doc ID
                option.textContent = s.data().nama;
                supervisorSelect.appendChild(option);

                // Cek UID - match dengan projectData.supervisor (bisa string atau object)
                const supervisorUid = s.data().uid;
                const projectSupervisorValue = projectData.supervisor;

                // Jika projectData.supervisor adalah string UID
                if (typeof projectSupervisorValue === 'string' && projectSupervisorValue === supervisorUid) {
                    supervisorDocIdToSet = s.id;
                    console.log('Match: UID string, set doc ID ke:', s.id);
                }
                // Jika projectData.supervisor adalah object dengan property uid atau id
                else if (typeof projectSupervisorValue === 'object' && projectSupervisorValue !== null) {
                    if (projectSupervisorValue.uid === supervisorUid || projectSupervisorValue.id === supervisorUid) {
                        supervisorDocIdToSet = s.id;
                        console.log('Match: UID object, set doc ID ke:', s.id);
                    }
                }
            });

            // SET DROPDOWN VALUE
            if (supervisorDocIdToSet) {
                supervisorSelect.value = supervisorDocIdToSet;
                console.log('Dropdown supervisor berhasil diset');
            } else {
                console.log('Supervisor tidak ditemukan, projectData.supervisor:', projectData.supervisor);
            }

            const teamSelect = document.getElementById('editTeamSelect');
            teamSelect.innerHTML = '<option value="">Pilih Tim</option>';
            const teamsSnap = await getDocs(collection(db, "tim_pekerja"));
            teamsSnap.forEach(t => {
                teamSelect.innerHTML += `<option value="${t.id}">${t.data().nama_tim}</option>`;
            });

            const workerSelection = document.getElementById('editWorkerSelection');
            workerSelection.innerHTML = '';

            const workersSnap = await getDocs(collection(db, "pekerja"));

            /* ðŸ”¥ 1. MASUKKAN KE ARRAY */
            const workers = [];
            workersSnap.forEach(w => {
                workers.push({
                    id: w.id,
                    ...w.data()
                });
            });

            /* ðŸ”¥ 2. SORT Aâ€“Z */
            workers.sort((a, b) =>
                a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' })
            );

            /* ðŸ”¥ 3. BARU RENDER */
            workers.forEach(w => {
                const checked = selectedWorkers.includes(w.id) ? 'checked' : '';

                workerSelection.innerHTML += `
                    <div class="worker-checkbox" data-nama="${w.nama.toLowerCase()}">
                        <input type="checkbox"
                            id="edit_worker_${w.id}"
                            value="${w.id}"
                            ${checked}
                            onchange="updateSelectedWorkers()">

                        <label for="edit_worker_${w.id}">
                            <div>${w.nama}</div>
                            <div class="worker-position">
                                ${w.keterangan || 'Pekerja'}
                            </div>
                        </label>
                    </div>
                `;
            });
            updateSelectedWorkers();
            document.getElementById('editModal').classList.add('show');
        }

        window.openEditModal = openEditModal;

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        window.closeEditModal = closeEditModal;

        function updateSelectedWorkers() {
            const checkboxes = document.querySelectorAll(
                '#editWorkerSelection input[type="checkbox"]:checked'
            );

            selectedWorkers = Array.from(checkboxes).map(cb => cb.value);

            const countText = document.getElementById('workerCountText');
            if (countText) {
                const jumlah = selectedWorkers.length;
                countText.textContent = `${jumlah} pekerja dipilih`;
            }
        }

        window.updateSelectedWorkers = updateSelectedWorkers;

        function filterWorkers() {
            const keyword = document.getElementById('workerSearch').value.toLowerCase();
            const workers = document.querySelectorAll('#editWorkerSelection .worker-checkbox');

            let shown = 0;

            workers.forEach(worker => {
                const nama = worker.getAttribute('data-nama');

                // jika search kosong â†’ tampilkan semua
                if (keyword === '') {
                    worker.style.display = 'flex';
                    return;
                }

                // jika cocok & belum lebih dari 5
                if (nama.includes(keyword) && shown < 5) {
                    worker.style.display = 'flex';
                    shown++;
                } else {
                    worker.style.display = 'none';
                }
            });
        }

        window.filterWorkers = filterWorkers;

        async function addTeamToEdit() {
            const teamId = document.getElementById('editTeamSelect').value;
            if (!teamId) {
                alert('Pilih tim terlebih dahulu');
                return;
            }

            const teamDoc = await getDoc(doc(db, "tim_pekerja", teamId));
            if (!teamDoc.exists()) return;

            const pekerjaTim = teamDoc.data().pekerja || [];

            pekerjaTim.forEach(member => {
                // ðŸ”¥ NORMALISASI ID
                const workerId =
                    typeof member === 'string'
                        ? member
                        : member.id || member.workerId;

                if (!workerId) return;

                const checkbox = document.getElementById(`edit_worker_${workerId}`);
                if (checkbox) checkbox.checked = true;
            });

            updateSelectedWorkers();
        }

        window.addTeamToEdit = addTeamToEdit;

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedWorkers.length === 0) {
                alert('Pilih minimal 1 pekerja');
                return;
            }

            const supervisorId = document.getElementById('editSupervisor').value;
            const supervisorDoc = await getDoc(doc(db, "supervisors", supervisorId));
            const supervisorData = supervisorDoc.data();

            const pekerjaDipilih = [];
            for (const workerId of selectedWorkers) {
                const workerDoc = await getDoc(doc(db, "pekerja", workerId));
                if (workerDoc.exists()) {
                    pekerjaDipilih.push({ id: workerDoc.id, nama: workerDoc.data().nama });
                }
            }

            await updateDoc(doc(db, "projects", projectId), {
                namaProyek: document.getElementById('editNamaProyek').value,
                namaClient: document.getElementById('editNamaClient').value,
                tanggalMulai: document.getElementById('editTanggalMulai').value,
                tenggat: document.getElementById('editTenggat').value,
                supervisor: { id: supervisorData.uid, nama: supervisorData.nama },
                pekerja: pekerjaDipilih,
                jumlahPekerja: pekerjaDipilih.length,
                lokasi: document.getElementById('editLokasi').value,
                deskripsi: document.getElementById('editDeskripsi').value,
            });

            alert('Proyek berhasil diperbarui');
            closeEditModal();
            // Reset search dan reload
            document.getElementById('pekerjaSearch').value = '';
            loadProject();
        });

        setInterval(() => {
            loadProject();
        }, 60000);
    </script>
</body>

</html>