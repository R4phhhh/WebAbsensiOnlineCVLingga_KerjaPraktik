<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyek Selesai - CV. LINGGA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            background: #f5f5f5;
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .logo {
            padding: 24px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: #4361ee;
            letter-spacing: 1px;
        }

        .menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #f8f9fa;
            border-left-color: #4361ee;
            color: #4361ee;
        }

        .menu-item.active {
            background: #f0f4ff;
            border-left-color: #4361ee;
            color: #4361ee;
            font-weight: 600;
        }

        .menu-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        .user-profile {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #c3c3c3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .user-email {
            font-size: 12px;
            color: #666;
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: 30px;
        }

        .content-header h2 {
            font-size: 32px;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .content-header p {
            font-size: 16px;
            color: #666;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #4361ee;
            color: white;
        }

        th {
            text-align: left;
            padding: 16px 20px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        td {
            padding: 16px 20px;
            color: #333;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            background: #d1fae5;
            color: #065f46;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .btn-detail {
            background: #f0f4ff;
            color: #4361ee;
        }

        .btn-hapus {
            background: #fee;
            color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s ease;
            z-index: 999;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #e5e7eb;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-submit {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #dc2626;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .search-container {
            position: relative;
            max-width: 420px;
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            padding: 12px 14px 12px 42px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            background: white;
            transition: all 0.25s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: #9ca3af;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo">
            <h1>CV. LINGGA</h1>
        </div>

        <div class="menu">
            <a class="menu-item" href="proyek_aktif.html">
                <i data-feather="briefcase" class="menu-item-icon"></i>
                <span>Proyek Aktif</span>
            </a>

            <a class="menu-item active" href="proyek_selesai.html">
                <i data-feather="check-square" class="menu-item-icon"></i>
                <span>Proyek Selesai</span>
            </a>

            <a class="menu-item" href="supervisor_lapangan.html">
                <i data-feather="users" class="menu-item-icon"></i>
                <span>Supervisor</span>
            </a>

            <a class="menu-item" href="pekerja.html">
                <i data-feather="tool" class="menu-item-icon"></i>
                <span>Pekerja</span>
            </a>
        </div>

        <div class="user-profile" onclick="window.location.href='profil.html'">
            <div class="user-avatar"></div>
            <div class="user-info">
                <div class="user-name">Loading...</div>
                <div class="user-email">Loading...</div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="content-header">
            <h2>Proyek Selesai</h2>
            <p>Lihat semua proyek yang sudah selesai</p>
        </div>

        <div class="search-container">
            <i data-feather="search" class="search-icon"></i>
            <input
                type="text"
                class="search-input"
                id="searchInput"
                placeholder="Cari nama proyek..."
                oninput="searchProjects()"
            >
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nama Proyek</th>
                        <th>Lokasi</th>
                        <th>Supervisor</th>
                        <th>Durasi</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="proyekList">
                    <tr>
                        <td colspan="6" class="empty-state">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header">
                <h3 id="confirmTitle">Konfirmasi</h3>
            </div>

            <p id="confirmMessage" style="margin:20px 0;color:#444;line-height:1.6;">
                Apakah Anda yakin?
            </p>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeConfirmModal()">Batal</button>
                <button class="btn-submit" id="confirmBtn">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZWXurY0DGfIWxeKTRvWv6aPohsGIG9OE",
            authDomain: "project-kp-fd649.firebaseapp.com",
            projectId: "project-kp-fd649"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        feather.replace();

        let currentUser = null;
        let allProyekSelesai = [];

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const q = query(
                    collection(db, "admin"),
                    where("email", "==", user.email)
                );

                const snap = await getDocs(q);

                const adminDoc = snap.docs[0];
                const adminData = adminDoc.data();

                document.querySelector('.user-name').textContent = adminData.nama;
                document.querySelector('.user-email').textContent = adminData.email;

                const avatarEl = document.querySelector('.user-avatar');

                if (adminData.avatar && adminData.avatar.startsWith("data:image")) {
                    avatarEl.innerHTML = `<img src="${adminData.avatar}">`;
                } else {
                    avatarEl.textContent = adminData.nama
                        .split(' ')
                        .map(n => n[0])
                        .join('')
                        .substring(0, 2)
                        .toUpperCase();
                }

                loadProyekSelesai();

            } catch (err) {
                console.error(err);
                alert("Gagal memuat data admin");
            }
        });

        async function loadProyekSelesai() {
            const snap = await getDocs(collection(db, "projects"));
            allProyekSelesai = [];

            snap.forEach((doc) => {
                const data = doc.data();
                if (data.status === "selesai" || data.status === "telat") {
                    allProyekSelesai.push({ id: doc.id, ...data });
                }
            });

            renderProyekTable(allProyekSelesai);
        }

        function renderProyekTable(data) {
            const proyekList = document.getElementById('proyekList');
            proyekList.innerHTML = '';

            if (data.length === 0) {
                proyekList.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            Proyek tidak ditemukan
                        </td>
                    </tr>
                `;
                return;
            }

            for (const project of data) {
                const lokasi = project.lokasi || "-";
                const lokasiShort = lokasi.split(',').slice(0, 3).join(',');

                let badgeColor = project.status === "selesai" ? "#d1fae5" : "#fee2e2";
                let badgeTextColor = project.status === "selesai" ? "#065f46" : "#b91c1c";
                let badgeLabel = project.status === "selesai" ? "Selesai" : "Telat";

                proyekList.innerHTML += `
                    <tr>
                        <td>
                            <strong>${project.namaProyek}</strong><br>
                            <small style="color:#999;text-transform:uppercase;">
                                ${project.namaClient}
                            </small>
                        </td>
                        <td>${lokasiShort}</td>
                        <td>
                            ${project.supervisor?.nama || '-'}<br>
                            <small style="color:#999;">
                                ${project.jumlahPekerja} Pekerja
                            </small>
                        </td>
                        <td>${project.tanggalMulai} - ${project.tenggat}</td>
                        <td>
                            <span class="badge" style="background:${badgeColor};color:${badgeTextColor}">
                                ${badgeLabel}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-detail" onclick="window.location.href='detail_proyek.html?id=${project.id}'">
                                    <i data-feather="eye"></i> Detail
                                </button>
                                <button class="btn-action btn-hapus" onclick="deleteProyek('${project.id}')">
                                    <i data-feather="trash-2"></i> Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            feather.replace();
        }

        let confirmAction = null;

        function openConfirmModal(title, message, action) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmAction = action;

            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
            confirmAction = null;
        }

        document.getElementById('confirmBtn').addEventListener('click', async () => {
            if (confirmAction) await confirmAction();
            closeConfirmModal();
        });

        window.openConfirmModal = openConfirmModal;
        window.closeConfirmModal = closeConfirmModal;

        function deleteProyek(id) {
            openConfirmModal(
                "Hapus Proyek",
                "Proyek ini akan dihapus permanen dan tidak dapat dikembalikan. Apakah Anda yakin?",
                async () => {
                    await deleteDoc(doc(db, "projects", id));
                    loadProyekSelesai();
                    renderProyekTable(allProyekSelesai);
                }
            );
        }

        window.deleteProyek = deleteProyek;

        document.getElementById('searchProyek').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();

            const filtered = allProyekSelesai.filter(p =>
                p.namaProyek.toLowerCase().includes(keyword)
            );

            renderProyekTable(filtered);
        });

        // ðŸ” Refresh otomatis tiap 1 menit
        setInterval(() => {
            loadProyekSelesai();
        }, 60000);

    </script>
</body>

</html>