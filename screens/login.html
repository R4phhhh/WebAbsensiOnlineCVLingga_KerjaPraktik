<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV. LINGGA - Login</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .left-section {
            width: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: white;
        }

        .left-section h1 {
            font-size: 48px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .right-section {
            width: 50%;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .content {
            width: 100%;
            max-width: 400px;
        }

        .content h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 32px;
            color: #1a1a1a;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            margin-top: 20px;
            color: #333;
        }

        input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
            margin-bottom: 4px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input::placeholder {
            color: #aaa;
        }

        #loginBtn {
            width: 100%;
            padding: 14px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 24px;
        }

        #loginBtn:hover {
            background: #3451d1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        #loginBtn:active {
            transform: translateY(0);
        }

        #backToLoginBtn {
            width: 100%;
            padding: 14px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
            display: none;
        }

        #status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        #status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        #status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .left-section,
            .right-section {
                width: 100%;
            }

            .left-section {
                padding: 40px 20px;
                min-height: 150px;
            }

            .left-section h1 {
                font-size: 36px;
            }
        }
    </style>
</head>

<body>
    <!-- Left Section with Gradient -->
    <div class="left-section">
        <h1>CV. LINGGA</h1>
    </div>

    <!-- Right Section with Login Form -->
    <div class="right-section">
        <!-- KONTEN LOGIN -->
        <div class="content">
            <h2>Selamat datang!</h2>

            <label for="email">Email</label>
            <input type="email" id="email" placeholder="E-mail..."><br>

            <div id="passwordWrapper">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Password..."><br>
            </div>
            <div id="forgotWrapper" style="text-align: right; margin-top: 6px;">
                <span id="forgotPassword" style="font-size: 13px; color: #4361ee; cursor: pointer;">
                    Lupa password?
                </span>
            </div>
            <button id="loginBtn">Log In</button>
            <button id="backToLoginBtn">Kembali ke Login</button>
            <div id="registerWrapper" style="text-align: center; margin-top: 14px;">
                <span style="font-size: 14px; color: #555;">
                    Belum punya akun?
                    <span id="goRegister"
                        style="color: #4361ee; cursor: pointer; font-weight: 500;">
                        Daftar disini!
                    </span>
                </span>
            </div>
            <div id="status"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            getDocs,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZWXurY0DGfIWxeKTRvWv6aPohsGIG9OE",
            authDomain: "project-kp-fd649.firebaseapp.com",
            projectId: "project-kp-fd649",
            storageBucket: "project-kp-fd649.appspot.com",
            messagingSenderId: "90304196213",
            appId: "1:90304196213:web:79b9e3bf6e262123d4123c",
            measurementId: "G-5Z3KJ0ZGMQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const firestoreTimeout = setTimeout(() => {
            console.warn("Firestore connection timeout - mungkin masalah koneksi internet atau rules");
        }, 10000);

        const goRegister = document.getElementById("goRegister");

        if (goRegister) {
        goRegister.addEventListener("click", () => {
            window.location.href = "register.html";
        });
        }


        document.addEventListener("DOMContentLoaded", () => {
            const loginBtn = document.getElementById("loginBtn");
            const emailInput = document.getElementById("email");
            const passwordInput = document.getElementById("password");
            const statusDiv = document.getElementById("status");

            passwordInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    loginBtn.click();
                }
            });

            const forgotPassword = document.getElementById("forgotPassword");

            let isForgotMode = false;
            const forgotWrapper = document.getElementById("forgotWrapper");
            const registerWrapper = document.getElementById("registerWrapper");
            const passwordWrapper = document.getElementById("passwordWrapper");
            const backBtn = document.getElementById("backToLoginBtn");

            forgotPassword.addEventListener("click", () => {
                isForgotMode = true;

                passwordWrapper.style.display = "none";
                forgotWrapper.style.display = "none";
                registerWrapper.style.display = "none";

                loginBtn.textContent = "Kirim Reset Password";
                backBtn.style.display = "block";

                statusDiv.style.display = "none";
                statusDiv.className = "";
                statusDiv.innerText = "";
            });

            backBtn.addEventListener("click", () => {
                isForgotMode = false;

                passwordWrapper.style.display = "block";
                forgotWrapper.style.display = "block";
                registerWrapper.style.display = "block";

                loginBtn.textContent = "Log In";
                backBtn.style.display = "none";

                passwordInput.value = "";

                statusDiv.style.display = "none";
                statusDiv.className = "";
                statusDiv.innerText = "";
            });

            loginBtn.addEventListener("click", async () => {
                const email = emailInput.value.trim();

                if (!email) {
                    showError("Email harus diisi");
                    return;
                }

                if (isForgotMode) {
                    try {
                        statusDiv.className = "";
                        statusDiv.innerText = "Mengirim email reset password...";
                        statusDiv.style.display = "block";

                        const q = query(
                            collection(db, "admin"),
                            where("email", "==", email)
                        );
                        const snap = await getDocs(q);

                        if (snap.empty) {
                            showError("Email tidak terdaftar");
                            return;
                        }

                        await sendPasswordResetEmail(auth, email, {
                            url: window.location.origin + "/login.html",
                            handleCodeInApp: false
                        });

                        statusDiv.className = "success";
                        statusDiv.innerText =
                            "Link reset password telah dikirim ke email Anda";

                    } catch (err) {
                        console.error(err);
                        showError("Gagal mengirim reset password");
                    }
                    return;
                }

                const password = passwordInput.value;

                if (!password) {
                    showError("Password harus diisi");
                    return;
                }

                try {
                    statusDiv.innerText = "Sedang login...";
                    statusDiv.style.display = "block";

                    const userCredential =
                        await signInWithEmailAndPassword(auth, email, password);

                    const user = userCredential.user;

                    if (!user.emailVerified) {
                        await signOut(auth);
                        showError("Email belum diverifikasi");
                        return;
                    }

                    const q = query(
                        collection(db, "admin"),
                        where("email", "==", user.email)
                    );
                    const snap = await getDocs(q);

                    if (snap.empty) {
                        await signOut(auth);
                        showError("Anda tidak memiliki akses admin");
                        return;
                    }

                    const adminData = snap.docs[0].data();

                    sessionStorage.setItem("admin_email", adminData.email);
                    sessionStorage.setItem("admin_nama", adminData.nama);
                    sessionStorage.setItem("is_admin", "true");

                    statusDiv.className = "success";
                    statusDiv.innerText = `Login berhasil!`;

                    setTimeout(() => {
                        window.location.href = "proyek_aktif.html";
                    }, 1200);

                } catch (err) {
                    handleAuthError(err);
                }
            });

            function showError(message) {
                statusDiv.className = "error";
                statusDiv.innerText = message;
                statusDiv.style.display = "block";

                setTimeout(() => {
                    statusDiv.style.display = "none";
                }, 5000);
            }

            function handleAuthError(error) {
                let errorMessage = "Login gagal: ";

                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage += "Format email tidak valid";
                        break;
                    case 'auth/user-disabled':
                        errorMessage += "Akun ini dinonaktifkan";
                        break;
                    case 'auth/user-not-found':
                        errorMessage += "Email tidak terdaftar";
                        break;
                    case 'auth/wrong-password':
                        errorMessage += "Password salah";
                        break;
                    case 'auth/network-request-failed':
                        errorMessage += "Koneksi internet bermasalah";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += "Terlalu banyak percobaan. Coba lagi nanti";
                        break;
                    default:
                        errorMessage += error.message;
                }

                showError(errorMessage);
            }

            window.addEventListener('beforeunload', () => {
                clearTimeout(firestoreTimeout);
            });
        });

        window.auth = auth;
        window.db = db;
    </script>

</body>

</html>